# GitHub Actions Workflow - Deploy VPC Network
name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      resource_type:
        description: 'Type of resource'
        required: true
        type: string
      resource_name:
        description: 'Name of the resource'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      region:
        description: 'AWS Region'
        required: true
        type: string
      argocd_app_name:
        description: 'ArgoCD Application name'
        required: true
        type: string

env:
  ARGOCD_SERVER: ${{ "${{" }} secrets.ARGOCD_SERVER {{ "}}" }}
  ARGOCD_AUTH_TOKEN: ${{ "${{" }} secrets.ARGOCD_AUTH_TOKEN {{ "}}" }}

jobs:
  deploy:
    name: Deploy to ArgoCD
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/
      
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ "${{" }} secrets.ARGOCD_SERVER {{ "}}" }}
          ARGOCD_AUTH_TOKEN: ${{ "${{" }} secrets.ARGOCD_AUTH_TOKEN {{ "}}" }}
        run: |
          argocd login "$ARGOCD_SERVER" \
            --auth-token "$ARGOCD_AUTH_TOKEN" \
            --plaintext \
            --grpc-web
      
      - name: Register Repository
        run: |
          argocd repo add ${{ "${{" }} github.server_url {{ "}}" }}/${{ "${{" }} github.repository {{ "}}" }}.git \
            --username ${{ "${{" }} github.actor {{ "}}" }} \
            --password ${{ "${{" }} secrets.GITHUB_TOKEN {{ "}}" }} \
            --insecure-skip-server-verification --upsert
        continue-on-error: true
      
      - name: Create ArgoCD Application
        run: |
          argocd app create ${{ "${{" }} inputs.argocd_app_name {{ "}}" }} \
            --repo ${{ "${{" }} github.server_url {{ "}}" }}/${{ "${{" }} github.repository {{ "}}" }}.git \
            --path manifests \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace default \
            --sync-policy automated \
            --auto-prune --self-heal --upsert
      
      - name: Sync Application
        run: |
          argocd app sync ${{ "${{" }} inputs.argocd_app_name {{ "}}" }} --async
          argocd app wait ${{ "${{" }} inputs.argocd_app_name {{ "}}" }} --timeout 600 --health
        continue-on-error: true
      
      - name: Summary
        run: |
          echo "## ðŸŒ VPC Network Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Network | ${{ "${{" }} inputs.resource_name {{ "}}" }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ "${{" }} inputs.environment {{ "}}" }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ "${{" }} inputs.region {{ "}}" }} |" >> $GITHUB_STEP_SUMMARY
