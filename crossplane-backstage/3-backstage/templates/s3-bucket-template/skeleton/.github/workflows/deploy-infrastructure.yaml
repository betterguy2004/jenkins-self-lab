# GitHub Actions Workflow - Triggered by Backstage
# STEP 6-7: Receives dispatch event and executes deployment
name: Deploy Infrastructure

on:
  # STEP 6: GitHub Actions receives dispatch event from Backstage
  workflow_dispatch:
    inputs:
      resource_type:
        description: 'Type of resource to deploy'
        required: true
        type: string
      resource_name:
        description: 'Name of the resource'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      region:
        description: 'AWS Region'
        required: true
        type: string
      argocd_app_name:
        description: 'ArgoCD Application name'
        required: true
        type: string

# Secrets are accessed directly in steps to avoid Backstage template rendering issues
  
jobs:
  # ============================================
  # STEP 7: Workflow executes deployment tasks
  # ============================================
  deploy:
    name: Deploy to ArgoCD
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/
      
      # ------------------------------------------
      # Login to ArgoCD
      # ------------------------------------------
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          argocd login "$ARGOCD_SERVER" \
            --auth-token "$ARGOCD_AUTH_TOKEN" \
            --plaintext \
            --grpc-web
      
      # ------------------------------------------
      # Register this repository with ArgoCD
      # ------------------------------------------
      - name: Register Repository in ArgoCD
        run: |
          # Add repository to ArgoCD
          argocd repo add ${{ github.server_url }}/${{ github.repository }}.git \
            --username ${{ github.actor }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --insecure-skip-server-verification \
            --upsert
        continue-on-error: true  # Repository might already exist
      
      # ------------------------------------------
      # Create ArgoCD Application
      # ------------------------------------------
      - name: Create ArgoCD Application
        run: |
          cat <<EOF | kubectl apply -f - --server-side
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: ${{ inputs.argocd_app_name }}
            namespace: argocd
            labels:
              app.kubernetes.io/managed-by: backstage
              backstage.io/kubernetes-id: ${{ inputs.argocd_app_name }}
              environment: ${{ inputs.environment }}
            annotations:
              argocd.argoproj.io/sync-wave: "0"
          spec:
            project: default
            source:
              repoURL: ${{ github.server_url }}/${{ github.repository }}.git
              targetRevision: main
              path: manifests
            destination:
              server: https://kubernetes.default.svc
              namespace: default
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
                allowEmpty: false
              syncOptions:
                - CreateNamespace=true
                - PrunePropagationPolicy=foreground
              retry:
                limit: 5
                backoff:
                  duration: 5s
                  factor: 2
                  maxDuration: 3m
          EOF
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
      
      # Alternative: Use ArgoCD CLI to create application
      - name: Create ArgoCD Application (CLI)
        run: |
          argocd app create ${{ inputs.argocd_app_name }} \
            --repo ${{ github.server_url }}/${{ github.repository }}.git \
            --path manifests \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace default \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert
        continue-on-error: true
      
      # ------------------------------------------
      # Trigger initial sync
      # ------------------------------------------
      - name: Sync ArgoCD Application
        run: |
          argocd app sync ${{ inputs.argocd_app_name }} --async
          
          echo "âœ… ArgoCD Application created and syncing!"
          echo ""
          echo "ðŸ“Š View status:"
          echo "  argocd app get ${{ inputs.argocd_app_name }}"
          echo ""
          echo "ðŸ”— ArgoCD URL: https://${{ env.ARGOCD_SERVER }}/applications/${{ inputs.argocd_app_name }}"
      
      # ------------------------------------------
      # Wait for sync and report status
      # ------------------------------------------
      - name: Wait for Sync Completion
        run: |
          echo "â³ Waiting for ArgoCD to sync resources..."
          argocd app wait ${{ inputs.argocd_app_name }} \
            --timeout 300 \
            --health \
            --sync
          
          echo ""
          echo "============================================"
          echo "âœ… Deployment Complete!"
          echo "============================================"
          argocd app get ${{ inputs.argocd_app_name }}
        continue-on-error: true  # Don't fail if wait times out
      
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | ${{ inputs.resource_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Name | ${{ inputs.resource_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ inputs.region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD App | ${{ inputs.argocd_app_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ArgoCD Application](https://${{ env.ARGOCD_SERVER }}/applications/${{ inputs.argocd_app_name }})" >> $GITHUB_STEP_SUMMARY
